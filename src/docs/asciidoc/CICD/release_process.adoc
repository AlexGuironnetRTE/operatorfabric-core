// Copyright (c) 2020, RTE (http://www.rte-france.com)
//
// This Source Code Form is subject to the terms of the Mozilla Public
// License, v. 2.0. If a copy of the MPL was not distributed with this
// file, You can obtain one at http://mozilla.org/MPL/2.0/.


[[release_process]]
= Release process

[[version_numbers]]
== Version numbers

We work with two types of versions:

* X.Y.Z.RELEASE versions are stable versions
* SNAPSHOT version represents the current state of merged developments

Version numbers for X.Y.Z.RELEASE should be understood like this:

* X: Major version, a major version adds new features and breaks compatibility with previous major and minor versions.
* Y: Minor version, a minor version adds new features and does not break compatibility with previous minor versions for
the same major version.
* Z: Patch, a patch version only contains bug fixes of current minor version

== Releasing a Version

IMPORTANT: To release a version we use some Travis dedicated jobs. These jobs are triggered by specific commit keywords
and rely on the VERSION file at the root of this repository to know which version is being produced.
It is thus crucial to double-check the content of this file before any push (triggering the Travis jobs) is made.

Before releasing a version, you need to prepare the release.

=== Check the release notes

. Click the `Next Release` from
link:https://opfab.atlassian.net/projects/OC?orderField=RANK&selectedItem=com.atlassian.jira.jira-projects-plugin%3Arelease-page&status=all[JIRA the release list]
to get the release notes (click "Release notes" under the version name at the top) listing new features, fixed bugs etc...
+
image::release_notes.png[Release notes link]
. Make sure that the
link:https://github.com/opfab/operatorfabric-core/blob/master/src/docs/asciidoc/docs/release_notes.adoc[release_notes.adoc]
file lists all the issues, bugs, tags or feature requests that are relevant for OperatorFabric users along with
explanations if need be.

. Based on the content of this version and the rules listed above, determine the version number for next version.

. In the release_notes.adoc file, replace the `Version SNAPSHOT` title by `Version X.X.X.RELEASE`
//TODO Make that part of prepare version script

. In the release page, change the name from "Next Version" to "X.X.X.RELEASE"
//TODO Check that renaming works ok, no side effects. Otherwise we will move issues to a new version

=== Create a release branch and prepare the release

. Create a branch off the `develop` branch named `X.X.X.release` (note the lowercase `release` to distinguish it from
`X.X.X.RELEASE` tags).
+
```
git checkout -b X.X.X.release
```

. Use the ./CICD/prepare_release_version.sh script to automatically perform all the necessary changes:
+
```
./CICD/prepare_release_version.sh -v X.X.X.RELEASE
```
+
You should get the following output:
+
----
Current version is SNAPSHOT (based on VERSION file)
Preparing X.X.X.RELEASE
Updating version for pipeline in VERSION file
Replacing SNAPSHOT with X.X.X.RELEASE in swagger.yaml files
Using X.X.X.RELEASE for lfeoperatorfabric images in deploy docker-compose file
The following files have been updated:
M VERSION
M services/core/actions/src/main/modeling/swagger.yaml
M services/core/cards-publication/src/main/modeling/swagger.yaml
M services/core/thirds/src/main/modeling/swagger.yaml
M services/core/users/src/main/modeling/swagger.yaml
M src/main/docker/deploy/docker-compose.yml
----
+
This script performs the following changes:
+
* Replace SNAPSHOT with X.X.X.RELEASE in swagger.yaml files and the VERSION file at the root operator-fabric folder
* Change the version from W.W.W.RELEASE (previous release) to X.X.X.RELEASE in the deploy docker-compose file
+
. Commit the changes with the template message:
+
```
git add .
git commit -m "[RELEASE] X.X.X.RELEASE"
```
+
. Push the commit
+
```
git push --set-upstream origin X.X.X.release
```

. Check that the build is correctly triggered
+
You can check the status of the build job triggered by the commit on
link:https://travis-ci.org/opfab/operatorfabric-core/branches[Travis CI].
The build job should have the following three stages:
+
image::release_branch_build.png[Running build for release branch screenshot]
+
Wait for the build to complete (around 20 minutes) and check that all stages have been successful.
This ensures that the code builds, tests are OK and there is no error preventing documentation or Docker images
generation.

=== Merge the release branch into master

Once the release branch build is passing, you should merge the release branch into `master` to bring the new
developments into `master` and trigger the CICD tasks associated with a release (Docker images for DockerHub and
documentation).

----
git checkout master <1>
git pull <2>
git merge X.X.X.release <3>
git tag X.X.X.RELEASE <4>
git push <5>
git push origin X.X.X.RELEASE <6>
----
<1> Check out the `master` branch
<2> Make sure your local copy is up to date
<3> Merge the `X.X.X.release` branch into `master`
<4> Tag the commit with the `X.X.X.RELEASE` tag
<5> Push the commits to update the remote `master` branch
<6> Push the tag

//TODO ci_latest commit in merge message? Can there be conflicts?
// TODO Should go through a PR (more risks to go to the wrong branch now that develop is default)?

. Check that the build is correctly triggered
+
You can check the status of the build job triggered by the commit on
link:https://travis-ci.org/opfab/operatorfabric-core/branches[Travis CI].
The build job should have the following four stages:
+
image::master_branch_build.png[Running build for master branch screenshot]
+
Wait for the build to complete (around 20 minutes) and check that all stages have been successful.

. Check that the `X.X.X.RELEASE` images have been generated and pushed to DockerHub.

. Check that the `latest` images have been updated on DockerHub.

. Check that the documentation has been generated and pushed to the GitHub pages website
.. Check the version and revision date at the top of the documents in the current documentation
(for example link:https://opfab.github.io/documentation/current/architecture/[the architecture documentation])
.. Check that you see the X.X.X.RELEASE under the link:https://opfab.github.io/pages/releases.html[releases page]
and that the links work.

. Check that the tag was correctly pushed to GitHub and is visible under the
https://github.com/opfab/operatorfabric-core/releases[releases page] for the repository.

=== Checking deploy docker-compose

The deploy docker-compose file should always rely on the latest RELEASE version
available on DockerHub. Once the CI pipeline triggered by the previous steps has completed successfully,
and you can see X.X.X.RELEASE images for all services on DockerHub, you should:

. Remove your locally built X.X.X.RELEASE images if any
. Run the deploy docker-compose file to make sure it pulls the images from DockerHub and behaves as intended.

=== In Jira

In the "Releases" screen, release `X.X.X.RELEASE`.

== Advertising the new release on the LFE mailing list

. Send an email to the opfab-announce@lists.lfenergy.org mailing list with a link to the release notes on the website.

== Preparing next version

IMPORTANT: You should wait for all the tasks associated with creating the X.X.X.RELEASE
version to finish and make sure that they've had the expected output before starting the
preparation of the next version. This is because any committed/pushed changes preparing the
new version will make rolling back or correcting any mistake on the release more complicated.

=== In Jira

. In the "Releases" screen create a new release called `Next Release`.

=== On the `develop` branch

. Change the release_notes.adoc file back to an "empty" template with `Version SNAPSHOT` as a title.
//TODO Find a way to avoid this
